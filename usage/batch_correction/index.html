<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
      <link rel="shortcut icon" href="../../img/favicon.ico" />
    <title>Correction of batch effects - DPKS Documentation</title>
    <link rel="stylesheet" href="../../css/theme.css" />
    <link rel="stylesheet" href="../../css/theme_extra.css" />
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/github.min.css" />
        <link href="../../assets/_mkdocstrings.css" rel="stylesheet" />
    
      <script>
        // Current page data
        var mkdocs_page_name = "Correction of batch effects";
        var mkdocs_page_input_path = "usage/batch_correction.md";
        var mkdocs_page_url = null;
      </script>
    
    <!--[if lt IE 9]>
      <script src="../../js/html5shiv.min.js"></script>
    <![endif]-->
      <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/highlight.min.js"></script>
      <script>hljs.highlightAll();</script> 
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
    <div class="wy-side-scroll">
      <div class="wy-side-nav-search">
          <a href="../..">
          <img src="../../img/logo.png" class="logo" alt="Logo"/>
        </a><div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../../search.html" method="get">
      <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" title="Type search term here" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../..">Home</a>
                </li>
              </ul>
              <p class="caption"><span class="caption-text">Usage</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../installation/">Installation</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../loading_data/">Loading data</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../normalization/">Normalization</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../quantification/">Quantification</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../statistical_comparisons/">Statistical Comparisons</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../explainable_machine_learning/">Explainable Machine Learning</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../pathway_analysis/">Pathway Analysis</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">Examples</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../../examples/">Notebooks</a>
                  </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../../contributing/">Contributing</a>
                </li>
              </ul>
              <p class="caption"><span class="caption-text">API Reference</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../../reference/quant_matrix_ref/">QuantMatrix</a>
                  </li>
              </ul>
      </div>
    </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">
      <nav class="wy-nav-top" role="navigation" aria-label="Mobile navigation menu">
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../..">DPKS Documentation</a>
        
      </nav>
      <div class="wy-nav-content">
        <div class="rst-content"><div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../.." class="icon icon-home" aria-label="Docs"></a></li>
      <li class="breadcrumb-item active">Correction of batch effects</li>
    <li class="wy-breadcrumbs-aside">
          <a href="https://github.com/InfectionMedicineProteomics/DPKS/edit/master/docs/usage/batch_correction.md" class="icon icon-github"> Edit on GitHub</a>
    </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
            <div class="section" itemprop="articleBody">
              
                <h1 id="correction-of-batch-effects">Correction of batch effects</h1>
<p>Normalization and correction is a crucial step in omics analysis to mitigate batch effects and technical variability between samples, ensuring that the observed signal reflects true biological variations rather than technical artifacts. DPKS currently offers two methods for handling batch effects:</p>
<ul>
<li>
<p><code>combat</code> - The Combat method is a tool for batch correction, leveraging the ComBat algorithm <sup id="fnref:1"><a class="footnote-ref" href="#fn:1">1</a></sup>. It models the sources of variation across batches and adjusts the data to harmonize feature distributions while preserving biological variability. </p>
</li>
<li>
<p><code>mean</code> - The mean normalization method corrects for batch effects by adjusting the data based on the mean values and standard deviations within each batch. This approach assumes systematic differences in mean expression levels between batches and aims to align them, reducing batch-related variability.</p>
</li>
</ul>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>The combat method is heavily influenced by missing data. Be careful when applying it if your dataset contains missing values.</p>
</div>
<p>Batch correction can be performed as follows:</p>
<pre><code class="language-python">from dpks.quant_matrix import QuantMatrix

qm = QuantMatrix(
    quantification_file=&quot;../tests/input_files/de_matrix.tsv&quot;,
    design_matrix_file=&quot;../tests/input_files/de_design_matrix.tsv&quot;
).filter().normalize(method=&quot;log2&quot;).correct(method=&quot;mean&quot;, reference_batch=1)

</code></pre>
<h2 id="example">Example</h2>
<pre><code class="language-py">import pandas as pd

from dpks.quant_matrix import QuantMatrix

design_matrix_file = &quot;../tests/input_files/de_design_matrix.tsv&quot;

design_matrix = pd.read_csv(design_matrix_file, sep=&quot;\t&quot;)
design_matrix[&quot;batch&quot;] = [1] * 10 + [2] * 8 # Dividing data into batches

import numpy as np

data_file = pd.read_csv(&quot;../tests/input_files/de_matrix.tsv&quot;, sep=&quot;\t&quot;)

quant_matrix = QuantMatrix(
    quantification_file=data_file,
    design_matrix_file=design_matrix,
).normalize(method=&quot;log2&quot;)

data_file = quant_matrix.to_df()
for sample in design_matrix[design_matrix[&quot;batch&quot;] == 1][&quot;sample&quot;]:
    data_file[sample] = data_file[sample] + 3 # Add synthetic batch effect
</code></pre>
<p>The data divides into batches.
<img alt="" src="../../img/non_corrected_umaps.png" />
<img alt="" src="../../img/non_corrected_boxes.png" />
<img alt="" src="../../img/non_corrected_density.png" /></p>
<p>Running batch correction removes the grouping on batch.</p>
<pre><code>quant_matrix = QuantMatrix(
    quantification_file=data_file,
    design_matrix_file=design_matrix,
)

quantified_data = (
    quant_matrix.filter().impute(method=&quot;uniform_percentile&quot;).correct(method=&quot;mean&quot;, reference_batch=1)
)
</code></pre>
<p><img alt="" src="../../img/corrected_umaps.png" />
<img alt="" src="../../img/corrected_boxes.png" />
<img alt="" src="../../img/corrected_density.png" /></p>
<div class="footnote">
<hr />
<ol>
<li id="fn:1">
<p>W. Evan Johnson, Cheng Li and Ariel Rabinovic. Adjusting batch effects in microarray expression data using empirical Bayes methods.
Biostatistics, 2007
<a href="https://doi.org/10.1093/biostatistics/kxj037" target="_blank">DOI: https://doi.org/10.1093/biostatistics/kxj037</a>&#160;<a class="footnote-backref" href="#fnref:1" title="Jump back to footnote 1 in the text">&#8617;</a></p>
</li>
</ol>
</div>
              
            </div>
          </div><footer>

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
  </div>

  Built with <a href="https://www.mkdocs.org/">MkDocs</a> using a <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
</footer>
          
        </div>
      </div>

    </section>

  </div>

  <div class="rst-versions" role="note" aria-label="Versions">
  <span class="rst-current-version" data-toggle="rst-current-version">
    
        <span>
          <a href="https://github.com/InfectionMedicineProteomics/DPKS" class="fa fa-github" style="color: #fcfcfc"> GitHub</a>
        </span>
    
    
    
  </span>
</div>
    <script src="../../js/jquery-3.6.0.min.js"></script>
    <script>var base_url = "../..";</script>
    <script src="../../js/theme_extra.js"></script>
    <script src="../../js/theme.js"></script>
      <script src="../../search/main.js"></script>
    <script>
        jQuery(function () {
            SphinxRtdTheme.Navigation.enable(true);
        });
    </script>

</body>
</html>
